<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CRM Pro Warner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { background: transparent; font-family: 'Plus Jakarta Sans', sans-serif; color: #f8fafc; overflow: hidden; }
        
        /* SCROLLBARS ELEGANTES */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #eed254; }

        /* KANBAN COLUMNS */
        .kanban-col { 
            min-width: 300px; width: 300px; 
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.4) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px; 
            display: flex; flex-direction: column; 
            margin-right: 16px; 
            transition: border-color 0.3s;
        }
        .kanban-col:hover { border-color: rgba(238, 210, 84, 0.1); }
        .kanban-header { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* CARDS */
        .card { 
            background: rgba(30, 41, 59, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.03); 
            border-radius: 12px; 
            padding: 14px; margin-bottom: 10px; cursor: grab; 
            position: relative; overflow: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .card:hover { 
            transform: translateY(-3px) scale(1.01); 
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(238, 210, 84, 0.4); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        .card:active { cursor: grabbing; transform: scale(0.98); }

        /* CATEGORY INDICATORS */
        .cat-indicator { width: 3px; position: absolute; left: 0; top: 12px; bottom: 12px; border-radius: 0 4px 4px 0; }
        .bg-COMPRADOR { background-color: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .bg-INQUILINO { background-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
        .bg-VENDEDOR { background-color: #eed254; box-shadow: 0 0 10px rgba(238, 210, 84, 0.3); }
        .bg-PROPIETARIO { background-color: #a855f7; box-shadow: 0 0 10px rgba(168, 85, 247, 0.3); }

        /* MODAL */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); 
            z-index: 60; display: none; align-items: center; justify-content: center; 
            backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; }
        
        .modal-content { 
            background: #0f172a; width: 800px; max-width: 95%; height: 85vh; 
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
            display: flex; overflow: hidden; transform: scale(0.95); transition: transform 0.3s;
        }
        
        /* CREATE MODAL CONTENT (SMALLER) */
        .modal-content-sm {
            background: #0f172a; width: 600px; max-width: 95%; max-height: 90vh;
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
            display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95); transition: transform 0.3s;
        }

        .modal-overlay.show .modal-content, .modal-overlay.show .modal-content-sm { transform: scale(1); }

        /* CHAT BUBBLES FOR NOTES */
        .note-bubble { background: #1e293b; padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; }
        .note-date { font-size: 0.65rem; color: #64748b; margin-bottom: 2px; font-weight: 700; text-transform: uppercase; }

        /* AVATAR GENERATOR */
        .avatar { display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.7rem; color: #0f172a; }
        
        /* DATE INPUT RESET */
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        /* TAB STYLES FOR CREATE MODAL */
        .hidden { display: none; }
        .tab-active { background: #eed254; color: #0f172a; border-color: #eed254; }
        .tab-inactive { background: #1e293b; color: #94a3b8; border-color: #334155; }
        .tab-inactive:hover { background: #334155; color: white; }
    </style>
</head>
<body class="flex flex-col h-screen p-4 sm:p-6 select-none">

    <header class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 gap-6 shrink-0">
        
        <div class="flex flex-col sm:flex-row gap-4 w-full xl:w-auto">
            <div class="bg-slate-900/80 p-1.5 rounded-xl border border-slate-700/50 flex shadow-lg">
                <button onclick="setMode('KANBAN')" id="btn-kanban" class="px-5 py-2 text-xs font-bold rounded-lg transition-all flex items-center gap-2">
                    <i class="ph-bold ph-kanban"></i> PIPELINE
                </button>
                <button onclick="setMode('AGENDA')" id="btn-agenda" class="px-5 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all flex items-center gap-2">
                    <i class="ph-bold ph-calendar"></i> AGENDA
                </button>
            </div>

            <div class="relative group w-full sm:w-64">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="ph-bold ph-magnifying-glass text-slate-500 group-focus-within:text-[#eed254] transition"></i>
                </div>
                <input type="text" id="search" onkeyup="render()" placeholder="Buscar cliente, propiedad..." 
                    class="block w-full pl-10 pr-3 py-2.5 border border-slate-700/50 rounded-xl leading-5 bg-slate-900/50 text-slate-300 placeholder-slate-500 focus:outline-none focus:bg-slate-900 focus:border-[#eed254] focus:ring-1 focus:ring-[#eed254] sm:text-sm transition-all shadow-lg">
            </div>
        </div>

        <div class="hidden 2xl:flex items-center gap-6 bg-slate-900/40 px-6 py-2 rounded-full border border-slate-800 backdrop-blur">
            <div class="flex flex-col items-center">
                <span class="text-[10px] text-slate-400 font-bold tracking-wider">TOTAL CLIENTES</span>
                <span id="metric-total" class="text-lg font-bold text-white">0</span>
            </div>
            <div class="w-px h-8 bg-slate-700"></div>
            <div class="flex flex-col items-center">
                <span class="text-[10px] text-slate-400 font-bold tracking-wider">EN GESTIÓN</span>
                <span id="metric-gestion" class="text-lg font-bold text-[#eed254]">0</span>
            </div>
        </div>

        <div class="flex items-center gap-3 w-full xl:w-auto overflow-x-auto pb-1 xl:pb-0">
            <div id="cat-selector" class="flex p-1 bg-slate-900/50 rounded-xl border border-slate-700/50 backdrop-blur-md">
                <button onclick="setCat('COMPRADOR')" id="cat-COMPRADOR" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all border border-transparent">COMPRA</button>
                <button onclick="setCat('INQUILINO')" id="cat-INQUILINO" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all border border-transparent">ALQUILER</button>
                <button onclick="setCat('VENDEDOR')" id="cat-VENDEDOR" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all border border-transparent">VENTA</button>
                <button onclick="setCat('PROPIETARIO')" id="cat-PROPIETARIO" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all border border-transparent">PROP</button>
            </div>
            
            <button onclick="openCreateModal()" class="p-3 bg-[#eed254] hover:bg-[#d4b93a] text-slate-900 font-bold rounded-xl transition shadow-lg flex items-center gap-2" title="Crear Cliente">
                <i class="ph-bold ph-plus"></i> <span class="hidden sm:inline text-xs">NUEVO</span>
            </button>

            <button onclick="loadData()" class="p-3 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-xl transition shadow-lg border border-slate-700/50" title="Sincronizar">
                <i class="ph-bold ph-arrows-clockwise text-lg"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-hidden relative rounded-2xl">
        <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center z-50 bg-slate-950/90 backdrop-blur-sm transition-opacity">
            <div class="relative">
                <div class="w-12 h-12 rounded-full border-4 border-slate-800 border-t-[#eed254] animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <i class="ph-fill ph-film-strip text-[#eed254] text-xs"></i>
                </div>
            </div>
            <p class="text-xs text-slate-400 mt-4 font-bold tracking-widest animate-pulse">WARNER SYSTEM</p>
        </div>

        <div id="view-kanban" class="h-full flex overflow-x-auto pb-4 px-2 items-start custom-scroll scroll-smooth"></div>

        <div id="view-agenda" class="h-full hidden overflow-y-auto px-4 custom-scroll">
            <div class="max-w-5xl mx-auto py-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-4 border-b border-red-500/30 pb-2">
                            <i class="ph-duotone ph-warning-circle text-red-500 text-xl"></i>
                            <h3 class="text-red-400 font-bold text-sm tracking-wide">VENCIDOS</h3>
                        </div>
                        <div id="agenda-overdue" class="space-y-3 min-h-[100px]"></div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-4 border-b border-[#eed254]/30 pb-2">
                            <i class="ph-duotone ph-bell-ringing text-[#eed254] text-xl"></i>
                            <h3 class="text-[#eed254] font-bold text-sm tracking-wide">HOY</h3>
                        </div>
                        <div id="agenda-today" class="space-y-3 min-h-[100px]"></div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-4 border-b border-blue-500/30 pb-2">
                            <i class="ph-duotone ph-calendar-check text-blue-500 text-xl"></i>
                            <h3 class="text-blue-400 font-bold text-sm tracking-wide">FUTURO</h3>
                        </div>
                        <div id="agenda-future" class="space-y-3 min-h-[100px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal" class="modal-overlay">
        <div class="modal-content flex flex-row">
            <div class="w-1/3 bg-slate-900 border-r border-slate-800 p-6 flex flex-col overflow-y-auto custom-scroll">
                
                <div class="text-center mb-6">
                    <div id="m-avatar-large" class="w-20 h-20 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 mx-auto mb-4 flex items-center justify-center text-2xl font-bold text-white shadow-xl border border-slate-600"></div>
                    <h2 class="text-xl font-bold text-white leading-tight" id="m-name"></h2>
                    <span id="m-cat-badge" class="inline-block mt-2 px-3 py-1 rounded-full text-[10px] font-bold bg-slate-800 text-slate-400 border border-slate-700"></span>
                </div>

                <div class="space-y-6 flex-1">
                    <div class="space-y-3">
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-800 pb-1">Contacto</h4>
                        <div class="flex items-center gap-3 text-sm text-slate-300">
                            <i class="ph-duotone ph-phone text-slate-500"></i>
                            <span id="m-tel" class="select-all"></span>
                            <a id="btn-wp" target="_blank" class="ml-auto text-green-500 hover:text-green-400 transition hover:scale-110"><i class="ph-fill ph-whatsapp-logo text-lg"></i></a>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-slate-300">
                            <i class="ph-duotone ph-envelope text-slate-500"></i>
                            <span id="m-mail" class="truncate select-all" title=""></span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-800 pb-1">Interés</h4>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                            <div class="flex items-start gap-2">
                                <i class="ph-duotone ph-house-line text-[#eed254] mt-0.5"></i>
                                <div>
                                    <p id="m-prop" class="text-sm font-bold text-white leading-snug"></p>
                                    <p id="m-zona" class="text-xs text-slate-400 mt-1"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-slate-800">
                    <div class="text-[10px] text-slate-600 font-mono" id="m-id-display">ID: ---</div>
                </div>
            </div>

            <div class="w-2/3 bg-[#0f172a] flex flex-col">
                <div class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/50">
                    <h3 class="font-bold text-slate-300">Gestión y Actividad</h3>
                    <button onclick="toggleModal(false)" class="w-8 h-8 rounded-full hover:bg-slate-800 flex items-center justify-center transition text-slate-500 hover:text-white">
                        <i class="ph-bold ph-x text-lg"></i>
                    </button>
                </div>

                <div class="p-6 grid grid-cols-2 gap-4 border-b border-slate-800 bg-slate-900/20">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">ETAPA DEL PIPELINE</label>
                        <div class="relative">
                            <select id="input-stage" class="w-full bg-slate-800 border border-slate-600 text-white text-xs rounded-lg p-2.5 appearance-none focus:border-[#eed254] focus:ring-1 focus:ring-[#eed254] outline-none transition cursor-pointer font-medium"></select>
                            <i class="ph-bold ph-caret-down absolute right-3 top-3 text-slate-500 pointer-events-none text-xs"></i>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">PRÓXIMA ACCIÓN</label>
                        <div class="flex gap-2">
                            <input type="date" id="input-date" class="w-full bg-slate-800 border border-slate-600 text-white text-xs rounded-lg p-2.5 focus:border-[#eed254] focus:ring-1 focus:ring-[#eed254] outline-none transition uppercase">
                            <button onclick="clearAgenda()" class="px-3 bg-red-500/20 hover:bg-red-500/40 text-red-400 border border-red-500/30 rounded-lg transition" title="Borrar recordatorio">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 bg-[#0f172a] custom-scroll relative">
                    <div id="m-history" class="space-y-4 pb-20"></div>
                    
                    <div id="empty-history" class="hidden absolute inset-0 flex items-center justify-center flex-col opacity-30">
                        <i class="ph-duotone ph-chat-teardrop-text text-6xl mb-2"></i>
                        <span class="text-sm">No hay notas registradas</span>
                    </div>
                </div>

                <div class="p-4 bg-slate-900 border-t border-slate-800">
                    <div class="relative">
                        <input type="text" id="input-note" placeholder="Escribe una nota, detalle de llamada o avance..." 
                            class="w-full bg-slate-800 border border-slate-700 text-sm rounded-xl py-3 pl-4 pr-32 text-white placeholder-slate-500 focus:outline-none focus:border-[#eed254] transition shadow-inner">
                        <button onclick="saveChanges()" id="btn-save" class="absolute right-1.5 top-1.5 bottom-1.5 bg-[#eed254] hover:bg-[#d4b93a] text-slate-900 font-bold px-4 rounded-lg text-xs transition shadow-lg flex items-center gap-2">
                            <span>GUARDAR</span> <i class="ph-bold ph-paper-plane-right"></i>
                        </button>
                    </div>
                    <div class="mt-2 flex justify-between items-center px-1">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-500">Reasignar:</span>
                             <select id="input-op" class="bg-transparent border-none text-[10px] text-slate-400 font-bold uppercase cursor-pointer hover:text-white focus:ring-0 p-0">
                                <option value="COMPRADOR">COMPRADOR</option>
                                <option value="INQUILINO">INQUILINO</option>
                                <option value="VENDEDOR">VENDEDOR</option>
                                <option value="PROPIETARIO">PROPIETARIO</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-create" class="modal-overlay">
        <div class="modal-content-sm p-6 relative bg-[#0f172a]">
            
            <button onclick="closeCreateModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white transition">
                <i class="ph-bold ph-x text-lg"></i>
            </button>
            
            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-[#eed254] text-slate-900 flex items-center justify-center">
                    <i class="ph-bold ph-user-plus"></i>
                </div>
                Nuevo Cliente
            </h2>

            <div class="grid grid-cols-2 gap-2 mb-6 bg-slate-900 p-1 rounded-xl border border-slate-700">
                <button onclick="setIntention('DEMANDA')" id="btn-demanda" class="text-center py-2 text-xs font-bold rounded-lg border border-transparent transition-all tab-active">
                    BUSCA (COMPRA/ALQ)
                </button>
                <button onclick="setIntention('OFERTA')" id="btn-oferta" class="text-center py-2 text-xs font-bold rounded-lg border border-transparent transition-all tab-inactive">
                    OFRECE (VENDE/ALQ)
                </button>
            </div>

            <div class="space-y-4 overflow-y-auto custom-scroll pr-2" style="max-height: 60vh;">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Origen</label>
                        <select id="new-origen" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                            <option value="FACEBOOK ADS">FACEBOOK ADS</option>
                            <option value="INSTAGRAM AGENTE">INSTAGRAM AGENTE</option>
                            <option value="REDES AGENTE">REDES AGENTE</option>
                            <option value="TIK TOK WARNER">TIK TOK WARNER</option>
                            <option value="CARTEL">CARTEL</option>
                            <option value="REFERIDO">REFERIDO</option>
                            <option value="OTRO">OTRO</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Operación *</label>
                        <select id="new-op" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                            </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nombre Completo *</label>
                    <input type="text" id="new-name" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white uppercase focus:border-[#eed254] focus:outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Teléfono</label>
                        <input type="text" id="new-tel" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Email</label>
                        <input type="email" id="new-email" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-800">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Tipo Inmueble</label>
                        <select id="new-prop" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                            <option value="CASA">CASA</option>
                            <option value="DEPARTAMENTO">DEPARTAMENTO</option>
                            <option value="TERRENO">TERRENO</option>
                            <option value="DUPLEX">DUPLEX</option>
                            <option value="LOCAL">LOCAL</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Zona</label>
                        <input type="text" id="new-zona" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white uppercase focus:border-[#eed254] focus:outline-none" placeholder="Ej: SUR">
                    </div>
                </div>

                <div id="demand-fields" class="space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Amb.</label>
                            <input type="number" id="new-amb" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Coch.</label>
                            <input type="number" id="new-coch" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Piso</label>
                            <input type="text" id="new-piso" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white uppercase focus:border-[#eed254] focus:outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Presupuesto</label>
                            <input type="number" id="new-pres" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Moneda</label>
                            <select id="new-moneda" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                                <option value="DOLARES">DOLARES</option>
                                <option value="PESOS">PESOS</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Crédito Hipot.</label>
                        <select id="new-cred" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white focus:border-[#eed254] focus:outline-none">
                            <option value="NO">NO</option>
                            <option value="SI">SI</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Observaciones</label>
                    <textarea id="new-nota" rows="2" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-xs text-white uppercase focus:border-[#eed254] focus:outline-none resize-none"></textarea>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-slate-700 flex justify-end gap-3">
                <button onclick="closeCreateModal()" class="px-4 py-2 text-slate-400 font-bold text-xs hover:text-white transition">CANCELAR</button>
                <button onclick="createNewClient()" id="btn-create" class="px-5 py-2 bg-[#eed254] hover:bg-[#d4b93a] text-slate-900 font-bold text-xs rounded-lg transition flex items-center gap-2">
                    CREAR <i class="ph-bold ph-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  URL API DEPLOY (¡ACTUALIZAR SIEMPRE!)
        // ==========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwiLEu9LNja_nScMVhy5FCQViwSfDew-T8GqlmgRxiPwoqoJnafttej4eo3zbqdtGHxCQ/exec';

        // CONFIGURACIÓN DE ETAPAS
        const STAGES = [
            { id: 'INGRESO', label: 'NUEVO INGRESO', color: '#94a3b8', icon: 'ph-sparkle' },
            { id: 'CONTACTADO', label: 'CONTACTADO', color: '#60a5fa', icon: 'ph-chat-circle-dots' },
            { id: 'GESTION', label: 'EN GESTIÓN', color: '#fbbf24', icon: 'ph-briefcase' },
            { id: 'RESERVA', label: 'RESERVA / SEÑA', color: '#c084fc', icon: 'ph-handshake' },
            { id: 'CERRADO', label: 'CERRADO', color: '#4ade80', icon: 'ph-check-circle' }
        ];

        let db=[], viewMode='KANBAN', currentCat='COMPRADOR', user=null, selectedId=null;
        let createIntention = 'DEMANDA'; // Variable para controlar el modal

        // --- HERRAMIENTAS DE SEGURIDAD Y UX ---
        // 1. Sanitizador para evitar Inyección de Código (XSS)
        const sanitize = (str) => {
            if (!str) return "";
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        };

        // 2. Sistema de Notificaciones Moderno (Toasts)
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgClass = type === 'success' ? 'bg-emerald-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
            const icon = type === 'success' ? 'ph-check-circle' : (type === 'error' ? 'ph-warning' : 'ph-info');
            
            toast.className = `${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl font-bold text-sm flex items-center gap-3 transition-all duration-300 transform translate-y-2 opacity-0 pointer-events-auto border border-white/20`;
            toast.innerHTML = `<i class="ph-bold ${icon} text-xl"></i> <span>${sanitize(message)}</span>`;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // Animación de entrada
            setTimeout(() => { toast.classList.remove('translate-y-2', 'opacity-0'); }, 10);
            
            // Auto-destrucción
            setTimeout(() => {
                toast.classList.add('translate-y-2', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }


        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            const stored = localStorage.getItem('warnerUser');
            if(stored) {
                user = JSON.parse(stored);
                initModalSelects();
                loadData();
            } else { 
                document.body.innerHTML='<div class="h-full flex flex-col items-center justify-center text-slate-500 font-bold gap-4"><i class="ph-duotone ph-lock-key text-6xl text-red-500"></i><span>Sesión requerida. Inicie desde el Panel.</span></div>'; 
            }
        });

        function initModalSelects() {
            const sel = document.getElementById('input-stage');
            STAGES.forEach(s => {
                const o=document.createElement('option'); o.value=s.id; o.text=s.label; sel.appendChild(o)
            });
        }

        // --- CARGA DE DATOS ---
        async function loadData() {
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden', 'opacity-0');
            
            try {
                const res = await fetch(`${API_URL}?action=getData`);
                const data = await res.json();
                
                if (data.length > 0 && data[0].id === 'ERR') {
                    showToast("⚠️ Error del sistema: " + data[0].nom);
                    db = [];
                } else {
                    const esSuper = user.role === 'ADMIN' || user.cargo.toLowerCase().includes('lider') || user.cargo.toLowerCase().includes('director');
                    
                    if (!esSuper && user.role === 'AGENTE') {
                        const normalize = s => s ? s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim() : "";
                        const uTokens = normalize(user.name).split(" ");
                        db = data.filter(d => {
                            if(!d.agente) return false;
                            const aTokens = normalize(d.agente).split(" ");
                            return aTokens.some(t => uTokens.includes(t));
                        });
                    } else {
                        db = data;
                    }
                }
                updateMetrics();
                render();
            } catch(e) {
                console.error(e);
                showToast("Error de conexión. Intente recargar.");
            } finally {
                loader.classList.add('opacity-0');
                setTimeout(()=>loader.classList.add('hidden'), 300);
            }
        }

        function updateMetrics() {
            document.getElementById('metric-total').textContent = db.length;
            const gestion = db.filter(d => d.etapa === 'GESTION').length;
            document.getElementById('metric-gestion').textContent = gestion;
        }

        // --- RENDERIZADO ---
        function render() {
            if(viewMode==='KANBAN') renderKanban(); else renderAgenda();
        }

        function renderKanban() {
            const cont = document.getElementById('view-kanban'); cont.innerHTML = '';
            const term = document.getElementById('search').value.toLowerCase();
            
            const filtered = db.filter(d => d.cat === currentCat && (d.nom.toLowerCase().includes(term) || (d.prop && d.prop.toLowerCase().includes(term))));

            if(filtered.length === 0) {
                cont.innerHTML = `
                    <div class="w-full h-full flex flex-col items-center justify-center text-slate-600 opacity-50 mt-20">
                        <i class="ph-duotone ph-magnifying-glass text-6xl mb-4"></i>
                        <span class="text-sm font-bold">No se encontraron resultados</span>
                    </div>`;
                return;
            }

            STAGES.forEach(st => {
                const items = filtered.filter(d => (d.etapa||'INGRESO') === st.id);
                const col = document.createElement('div');
                col.className = 'kanban-col shrink-0';
                col.id = `col-${st.id}`;
                col.ondrop = drop; col.ondragover = allowDrop;

                col.innerHTML = `
                    <div class="kanban-header flex justify-between items-center sticky top-0 bg-inherit rounded-t-[16px] z-10 backdrop-blur-xl">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full" style="background:${st.color}"></div>
                            <span class="font-extrabold text-xs text-slate-300 tracking-wide">${st.label}</span>
                        </div>
                        <span class="bg-slate-800 text-slate-400 px-2 py-0.5 rounded-md text-[10px] font-mono border border-slate-700">${items.length}</span>
                    </div>
                    <div class="kanban-body custom-scroll p-3 space-y-3 h-full">
                        ${items.map(i => cardHTML(i)).join('')}
                    </div>`;
                cont.appendChild(col);
            });
        }

        function renderAgenda() {
            const ov=document.getElementById('agenda-overdue'), tod=document.getElementById('agenda-today'), fut=document.getElementById('agenda-future');
            ov.innerHTML=''; tod.innerHTML=''; fut.innerHTML='';
            
            const term = document.getElementById('search').value.toLowerCase();
            const now = new Date(); now.setHours(0,0,0,0);
            
            const list = db.filter(d => d.agenda && (d.nom.toLowerCase().includes(term) || d.prop?.toLowerCase().includes(term))).sort((a,b)=>new Date(a.agenda)-new Date(b.agenda));
            
            list.forEach(i => {
                const d = new Date(i.agenda); d.setHours(0,0,0,0);
                const html = cardHTML(i, true);
                if(d < now) ov.insertAdjacentHTML('beforeend', html);
                else if(d.getTime()===now.getTime()) tod.insertAdjacentHTML('beforeend', html);
                else fut.insertAdjacentHTML('beforeend', html);
            });
        }

        function cardHTML(i, isAgenda=false) {
            let badge = '';
            if(i.agenda) {
                const d = new Date(i.agenda); const n=new Date(); n.setHours(0,0,0,0); d.setHours(0,0,0,0);
                const str = d.toLocaleDateString('es-AR', {day:'2-digit', month:'short'});
                
                if(d<n) badge=`<div class="bg-red-500/10 text-red-400 px-2 py-0.5 rounded text-[10px] font-bold flex items-center gap-1 border border-red-500/20"><i class="ph-fill ph-warning"></i> ${str}</div>`;
                else if(d.getTime()===n.getTime()) badge=`<div class="bg-[#eed254]/10 text-[#eed254] px-2 py-0.5 rounded text-[10px] font-bold flex items-center gap-1 border border-[#eed254]/20"><i class="ph-fill ph-bell-ringing"></i> HOY</div>`;
                else if(isAgenda) badge=`<div class="bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded text-[10px] font-bold flex items-center gap-1 border border-blue-500/20"><i class="ph-fill ph-calendar"></i> ${str}</div>`;
            }

            const cleanTel = (i.tel||'').replace(/[^0-9]/g,'');
            const initials = i.nom ? i.nom.split(" ").map(n=>n[0]).slice(0,2).join("") : "?";
            const avatarColor = ['bg-emerald-500', 'bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-orange-500'][Math.floor(Math.random()*5)];

            return `
            <div class="card group" draggable="true" ondragstart="drag(event)" id="${i.id}" onclick="openModal('${i.id}')">
                <div class="cat-indicator bg-${i.cat}"></div>
                
                <div class="flex justify-between items-start mb-3 pl-2">
                    <div class="flex items-center gap-2">
                         <div class="w-6 h-6 rounded-full ${avatarColor} text-slate-900 text-[9px] font-bold flex items-center justify-center shadow-lg border border-white/10">
                            ${initials}
                         </div>
                         <div class="flex flex-col">
                            <span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider leading-none">${i.cat}</span>
                         </div>
                    </div>
                    ${badge}
                </div>

                <div class="pl-2 mb-2">
                    <h4 class="text-sm font-bold text-white group-hover:text-[#eed254] transition truncate" title="${i.nom}">${i.nom}</h4>
                    ${i.prop ? `<div class="flex items-center gap-1 text-[11px] text-slate-400 mt-1 truncate"><i class="ph-duotone ph-map-pin text-slate-500"></i> ${i.prop}</div>` : ''}
                </div>

                <div class="flex items-center justify-between border-t border-slate-700/30 pt-2 pl-2 mt-2">
                    <div class="text-[10px] text-slate-500 font-mono">${i.tel ? 'Movil' : 'Mail'}</div>
                    <div class="flex gap-1 opacity-40 group-hover:opacity-100 transition">
                         ${cleanTel ? `<a href="https://wa.me/${cleanTel}" target="_blank" onclick="event.stopPropagation()" class="p-1.5 bg-green-500/20 text-green-400 rounded hover:bg-green-500 hover:text-white transition"><i class="ph-bold ph-whatsapp-logo"></i></a>` : ''}
                         <button class="p-1.5 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 hover:text-white transition"><i class="ph-bold ph-pencil-simple"></i></button>
                    </div>
                </div>
            </div>`;
        }

        // --- MODAL EDICION ---
        function openModal(id) {
            selectedId = id;
            const i = db.find(d => d.id === id); if(!i) return;

            document.getElementById('m-name').textContent = i.nom;
            document.getElementById('m-cat-badge').textContent = i.cat;
            document.getElementById('m-tel').textContent = i.tel || '---';
            document.getElementById('m-mail').textContent = i.mail || '---';
            document.getElementById('m-mail').title = i.mail || '';
            document.getElementById('m-prop').textContent = i.prop || "Sin propiedad asignada";
            document.getElementById('m-zona').textContent = i.zona || "";
            document.getElementById('m-id-display').textContent = `REF: ${i.id}`;
            
            const initials = i.nom ? i.nom.split(" ").map(n=>n[0]).slice(0,2).join("") : "#";
            document.getElementById('m-avatar-large').textContent = initials;

            const btnWp = document.getElementById('btn-wp');
            if(i.tel) {
                btnWp.href = `https://wa.me/${i.tel.replace(/[^0-9]/g,'')}`;
                btnWp.style.display = 'inline';
            } else { btnWp.style.display = 'none'; }

            document.getElementById('input-stage').value = i.etapa || 'INGRESO';
            document.getElementById('input-date').value = i.agenda ? i.agenda.split('T')[0] : '';
            document.getElementById('input-op').value = i.cat;
            document.getElementById('input-note').value = '';

            const histCont = document.getElementById('m-history');
            const emptyState = document.getElementById('empty-history');
            histCont.innerHTML = '';
            
            if(i.notas) {
                emptyState.classList.add('hidden');
                const lines = i.notas.split('\n');
                lines.forEach(line => {
                    if(line.trim()) {
                        const div = document.createElement('div');
                        div.className = 'note-bubble slide-in-bottom';
                        const dateMatch = line.match(/^\[(.*?)\]/);
                        let date = "REGISTRO";
                        let text = line;
                        if(dateMatch) {
                            date = dateMatch[1];
                            text = line.replace(dateMatch[0], '').trim();
                        }
                        div.innerHTML = `<div class="note-date">${date}</div><div class="text-slate-300 leading-relaxed">${text}</div>`;
                        histCont.appendChild(div);
                    }
                });
            } else {
                emptyState.classList.remove('hidden');
            }

            const modal = document.getElementById('modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function toggleModal(s) {
            const modal = document.getElementById('modal');
            if(s) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('show'), 10);
            } else {
                modal.classList.remove('show');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        }

        // --- FUNCIÓN PARA LIMPIAR INPUT DE FECHA ---
        function clearAgenda() {
            document.getElementById('input-date').value = '';
        }

        async function saveChanges() {
            const btn = document.getElementById('btn-save');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';
            btn.disabled = true;

            const payload = {
                id: selectedId,
                etapa: document.getElementById('input-stage').value,
                agenda: document.getElementById('input-date').value, 
                operacion: document.getElementById('input-op').value,
                nota: document.getElementById('input-note').value
            };

            const i = db.find(d => d.id === selectedId);
            if(i) {
                i.etapa = payload.etapa;
                i.agenda = payload.agenda ? new Date(payload.agenda).toISOString() : null; 
                i.cat = payload.operacion;
                if(payload.nota) i.notas = `[${new Date().toLocaleDateString('es-AR')}] ${payload.nota}\n${i.notas || ''}`;
            }

            try {
                toggleModal(false);
                updateMetrics();
                render();
                await fetch(`${API_URL}?action=updateClient&data=${encodeURIComponent(JSON.stringify(payload))}`);
            } catch(e) {
                console.error(e);
                showToast("Error guardando cambios.");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // --- MODAL DE CREACIÓN CON LÓGICA INTELIGENTE ---
        function setIntention(intent) {
            createIntention = intent;
            const btnDemanda = document.getElementById('btn-demanda');
            const btnOferta = document.getElementById('btn-oferta');
            const opSelect = document.getElementById('new-op');
            const demandFields = document.getElementById('demand-fields');

            if (intent === 'DEMANDA') { // BUSCAN (Compradores/Inquilinos)
                btnDemanda.className = "text-center py-2 text-xs font-bold rounded-lg border border-transparent transition-all tab-active";
                btnOferta.className = "text-center py-2 text-xs font-bold rounded-lg border border-transparent transition-all tab-inactive";
                demandFields.classList.remove('hidden');
                opSelect.innerHTML = '<option value="COMPRA">COMPRA</option><option value="ALQUILER">ALQUILER</option>';
            } else { // OFRECEN (Vendedores/Propietarios)
                btnDemanda.className = "text-center py-2 text-xs font-bold rounded-lg border border-transparent transition-all tab-inactive";
                btnOferta.className = "text-center py-2 text-xs font-bold rounded-lg border border-transparent transition-all tab-active";
                demandFields.classList.add('hidden'); // Vendedor no carga presupuesto, ni credito
                opSelect.innerHTML = '<option value="VENTA">VENTA</option><option value="ALQUILER">ALQUILER</option>';
            }
        }

        function openCreateModal() {
            const modal = document.getElementById('modal-create');
            document.querySelectorAll('#modal-create input, #modal-create textarea').forEach(i => i.value = '');
            setIntention('DEMANDA'); // Default
            modal.style.display = 'flex'; setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeCreateModal() {
            const modal = document.getElementById('modal-create');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function createNewClient() {
            const btn = document.getElementById('btn-create');
            const name = document.getElementById('new-name').value;
            
            if(!name) { showToast("El nombre es obligatorio"); return; }
            
            const payload = {
                intencion: createIntention, // 'DEMANDA' o 'OFERTA'
                agente: user.name, nombre: name,
                origen: document.getElementById('new-origen').value,
                telefono: document.getElementById('new-tel').value,
                email: document.getElementById('new-email').value,
                operacion: document.getElementById('new-op').value,
                inmueble: document.getElementById('new-prop').value,
                zona: document.getElementById('new-zona').value,
                ambientes: document.getElementById('new-amb').value,
                cochera: document.getElementById('new-coch').value,
                presupuesto: document.getElementById('new-pres').value,
                moneda: document.getElementById('new-moneda').value,
                credito: document.getElementById('new-cred').value,
                piso: document.getElementById('new-piso').value,
                nota: document.getElementById('new-nota').value
            };

            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}?action=createClient&data=${encodeURIComponent(JSON.stringify(payload))}`);
                const data = await res.json();
                
            if(data.success) {
                closeCreateModal();
                showToast("¡Cliente creado exitosamente!", "success");
                loadData();
            } else {
                showToast("Error: " + data.error, "error");
            }
            } catch(e) {
                console.error(e);
                alert("Error de conexión al crear cliente.");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // --- FILTROS Y ESTILOS ---
        function setMode(m) {
            viewMode = m;
            const kBtn = document.getElementById('btn-kanban');
            const aBtn = document.getElementById('btn-agenda');
            
            kBtn.className = "px-5 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all flex items-center gap-2";
            aBtn.className = "px-5 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all flex items-center gap-2";
            
            if(m==='KANBAN') {
                kBtn.className = "px-5 py-2 text-xs font-bold rounded-lg bg-[#eed254] text-slate-900 shadow-lg shadow-yellow-500/20 transition-all flex items-center gap-2";
                document.getElementById('view-kanban').classList.remove('hidden');
                document.getElementById('view-kanban').classList.add('flex');
                document.getElementById('view-agenda').classList.add('hidden');
                document.getElementById('cat-selector').style.opacity = '1';
                document.getElementById('cat-selector').style.pointerEvents = 'auto';
            } else {
                aBtn.className = "px-5 py-2 text-xs font-bold rounded-lg bg-[#eed254] text-slate-900 shadow-lg shadow-yellow-500/20 transition-all flex items-center gap-2";
                document.getElementById('view-kanban').classList.add('hidden');
                document.getElementById('view-kanban').classList.remove('flex');
                document.getElementById('view-agenda').classList.remove('hidden');
                document.getElementById('cat-selector').style.opacity = '0.5';
                document.getElementById('cat-selector').style.pointerEvents = 'none';
            }
            render();
        }

        function setCat(c) {
            currentCat = c;
            document.querySelectorAll('#cat-selector button').forEach(b => {
                b.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all border border-transparent text-slate-400 hover:text-white";
            });
            const activeBtn = document.getElementById('cat-'+c);
            let activeClass = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all border shadow-lg ";
            if(c==='COMPRADOR') activeClass += "bg-emerald-500/10 text-emerald-400 border-emerald-500/50";
            if(c==='INQUILINO') activeClass += "bg-blue-500/10 text-blue-400 border-blue-500/50";
            if(c==='VENDEDOR') activeClass += "bg-yellow-500/10 text-yellow-400 border-yellow-500/50";
            if(c==='PROPIETARIO') activeClass += "bg-purple-500/10 text-purple-400 border-purple-500/50";
            
            activeBtn.className = activeClass;
            render();
        }

        // --- DRAG & DROP ---
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            ev.target.style.opacity = "0.5";
        }
        function allowDrop(ev) { ev.preventDefault(); }
        
        function drop(ev) {
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            const card = document.getElementById(id);
            const col = ev.target.closest('.kanban-col');
            if(!col) return;
            
            const body = col.querySelector('.kanban-body');
            body.appendChild(card);
            
            const st = col.id.replace('col-', '');
            const i = db.find(d => d.id === id);
            
            if(i && i.etapa !== st) {
                i.etapa = st;
                updateMetrics();
                fetch(`${API_URL}?action=updateClient&data=${encodeURIComponent(JSON.stringify({id:id, etapa:st}))}`);
            }
            card.style.opacity = "1";
        }
    </script>
    <div id="toast-container" class="fixed bottom-4 right-4 z-[9999] flex flex-col gap-2 pointer-events-none"></div>
</body>
</html>