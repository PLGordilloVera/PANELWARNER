<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Rendimiento Agentes WARNER - ELITE VIEW</title>
<base target="_top" />

<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@600;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
/* ---------------------------------------------------- */
/* === VARIABLES & CORE === */
/* ---------------------------------------------------- */
:root {
    --bg-deep: #050b14;
    --bg-card: rgba(16, 33, 60, 0.65);
    --text-main: #e6f1ff;
    --text-muted: #8892b0;
    --accent-gold: #ffe863;
    --accent-gold-dark: #f1cb1f;
    --accent-gold-glow: rgba(255, 215, 0, 0.3);
    --accent-green: #64ffda;
    --accent-red: #ff5f56;
    --border-glass: rgba(255, 255, 255, 0.1);
    --font-tech: 'Rajdhani', sans-serif;
    --font-display: 'Orbitron', sans-serif;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-deep);
    color: var(--text-main);
    background-image: 
        radial-gradient(at 0% 0%, rgba(255, 215, 0, 0.08) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(10, 25, 47, 1) 0px, transparent 50%);
    background-attachment: fixed;
    min-height: 100vh;
    overflow-x: hidden;
}

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-deep); }
::-webkit-scrollbar-thumb { background: #30415a; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-gold); }

.main-content-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
    animation: fadeIn 1s ease-out;
}

/* ---------------------------------------------------- */
/* === COMPONENTS UI === */
/* ---------------------------------------------------- */

.cyber-header {
    text-align: center;
    margin-bottom: 50px;
    position: relative;
}

.cyber-header h1 {
    font-family: var(--font-display);
    font-size: clamp(1.8rem, 4vw, 3rem);
    background: linear-gradient(180deg, var(--accent-gold) 0%, var(--accent-gold-dark) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    text-transform: uppercase;
    letter-spacing: 4px;
    margin-bottom: 10px;
    filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
}

.status-pill {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    background: rgba(100, 255, 218, 0.1);
    border: 1px solid var(--accent-green);
    color: var(--accent-green);
    font-family: var(--font-tech);
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 1px;
}

.glass-card {
    background: var(--bg-card);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--border-glass);
    border-radius: 12px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    height: 100%;
}

.glass-card:hover {
    border-color: rgba(255, 215, 0, 0.3);
    box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.5);
}

.control-card { padding: 25px; }

.form-label {
    font-family: var(--font-tech);
    color: var(--accent-gold);
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-size: 0.9rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-select {
    background-color: rgba(5, 11, 20, 0.6) !important;
    color: #fff !important;
    border: 1px solid #30415a !important;
    border-radius: 6px;
    font-family: 'Inter', sans-serif;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.form-select:hover, .form-select:focus {
    border-color: var(--accent-gold) !important;
    box-shadow: 0 0 15px var(--accent-gold-glow) !important;
}

.kpi-wrapper {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 30px 20px;
    position: relative;
    overflow: hidden;
}

.kpi-wrapper::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 4px; height: 100%;
    background: var(--accent-gold);
    opacity: 0.5;
    transition: 0.3s;
}

.kpi-wrapper:hover::after { opacity: 1; box-shadow: 0 0 10px var(--accent-gold); }

.kpi-icon { font-size: 1.5rem; color: var(--text-muted); margin-bottom: 10px; }
.kpi-title { font-family: var(--font-tech); color: var(--text-muted); font-size: 1rem; letter-spacing: 2px; text-transform: uppercase; }
.kpi-value { font-family: var(--font-display); font-size: 2.8rem; font-weight: 700; color: #fff; margin-top: 5px; text-shadow: 0 0 20px rgba(255,255,255,0.1); }

.chart-container {
    padding: 20px;
    min-height: 500px;
    position: relative;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
    padding: 0 10px;
    border-bottom: 1px solid var(--border-glass);
    padding-bottom: 15px;
}

.chart-title {
    font-family: var(--font-tech);
    font-size: 1.5rem;
    color: var(--text-main);
    display: flex;
    align-items: center;
    gap: 10px;
}

.toolbar { display: flex; gap: 8px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 8px; }

.time-btn {
    background: transparent; border: none; color: var(--text-muted);
    font-family: var(--font-tech); font-weight: 700; padding: 6px 16px;
    border-radius: 6px; transition: all 0.3s; font-size: 0.9rem;
}
.time-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
.time-btn.active { background: var(--accent-gold); color: #000; box-shadow: 0 0 15px var(--accent-gold-glow); }

#loader-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-deep); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    flex-direction: column; transition: opacity 0.5s;
}

.loader-spinner {
    width: 60px; height: 60px; border: 3px solid transparent;
    border-top-color: var(--accent-gold); border-radius: 50%;
    animation: spin 1s linear infinite; margin-bottom: 20px;
}
.loader-text { font-family: var(--font-display); letter-spacing: 3px; animation: pulse 1.5s infinite; }

.footer-author {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-top: 4rem;
    font-family: var(--font-tech);
    color: var(--text-muted);
    font-weight: 700;
    letter-spacing: 2px;
    padding-bottom: 20px;
}

.github-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 2px solid var(--accent-gold);
    transition: transform 0.3s, box-shadow 0.3s;
    vertical-align: middle;
}

.github-avatar:hover {
    transform: scale(1.15);
    box-shadow: 0 0 15px var(--accent-gold);
    cursor: pointer;
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

@media (max-width: 768px) {
    .kpi-value { font-size: 2.2rem; }
    .chart-header { flex-direction: column; align-items: flex-start; gap: 15px; }
    .toolbar { width: 100%; justify-content: space-between; }
    .time-btn { padding: 6px 10px; font-size: 0.8rem; }
}
</style>
</head>

<body>

<div id="loader-overlay">
    <div class="loader-spinner"></div>
    <div class="loader-text">ESTABLECIENDO CONEXIÓN...</div>
</div>

<div class="main-content-wrapper">

    <header class="cyber-header">
        <h1>WARNER RENDIMIENTO</h1>
        <div id="status-pill-container">
            <span class="status-pill"><i class="fas fa-circle fa-xs me-2"></i>CARGADO EN TIEMPO REAL</span>
        </div>
    </header>

    <div class="row g-4 mb-4">
        <div class="col-12 col-md-6">
            <div class="glass-card control-card">
                <label for="agente-select" class="form-label"><i class="fas fa-user-astronaut"></i> AGENTE</label>
                <select id="agente-select" class="form-select">
                    <option value="">Cargando directorio...</option>
                </select>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="glass-card control-card">
                <label for="accion-select" class="form-label"><i class="fas fa-chart-line"></i> METRICA</label>
                <select id="accion-select" class="form-select">
                    <option value="CAPTACIONES">CAPTACIONES</option>
                    <option value="CARTELES">CARTELES</option>
                    <option value="CLIENTES">CLIENTES COMPRADORES</option>
                    <option value="CLIENTES VENDEDORES">CLIENTES VENDEDORES</option>
                    <option value="OPERACIONES CAPTADOR">OPERACIONES (CAPTADOR)</option>
                    <option value="OPERACIONES COLOCADOR">OPERACIONES (COLOCADOR)</option>
                    <option value="RESERVAS">RESERVAS</option>
                    <option value="RESEÑAS">RESEÑAS</option>
                    <option value="VALUACIONES">VALUACIONES REALIZADAS</option>
                    <option value="VISITAS">VISITAS A INMUEBLES</option>
                </select>
            </div>
        </div>
    </div>

    <div id="kpi-container" class="row mb-4 g-4">
    </div>

    <div class="glass-card chart-container">
        <div class="chart-header">
            <div class="chart-title">
                <i class="fas fa-poll" style="color:var(--accent-gold)"></i>
                <span id="chart-title-text">RENDIMIENTO HISTÓRICO</span>
            </div>
            <div class="toolbar">
                <button class="time-btn" data-period="7">7 D</button>
                <button class="time-btn" data-period="15">15 D</button>
                <button class="time-btn" data-period="30">30 D</button>
                <button class="time-btn active" data-period="MENSUAL">HIST</button>
            </div>
        </div>
        <div id="plotly-graph"></div>
    </div>

    <footer class="footer-author">
        CREATED BY 
        <a href="https://github.com/PLGordilloVera" target="_blank" title="Ver perfil de GitHub">
            <img src="https://github.com/PLGordilloVera.png" alt="Autor" class="github-avatar" />
        </a>
    </footer>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyFMsw7uxn-kvxn4wHOVLKjSijRhRk5YtzNpcspEdNjWFjoq71Jf2VZ193Sz_pjL-mK/exec";

// Referencias DOM
const LOADER = document.getElementById("loader-overlay");
const AGENTE_SELECT = document.getElementById("agente-select");
const ACCION_SELECT = document.getElementById("accion-select");
const KPI_CONTAINER = document.getElementById("kpi-container");
const CHART_TITLE = document.getElementById("chart-title-text");
const PLOTLY_GRAPH_ID = "plotly-graph";
const TIME_BUTTONS = document.querySelectorAll('.time-btn');

let DATA = [], INDICES = {}, AGENTES = [];
let agenteActual = "TODOS", accionActual = "CAPTACIONES", periodoActual = "MENSUAL";
const MESES = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];

// Utilidades
const pad2 = (n) => String(n).padStart(2, '0');
const formatDateISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

function aggregateSum(items, keyExtractor) {
    const map = new Map();
    items.forEach(i => { const k = keyExtractor(i); map.set(k, (map.get(k) || 0) + (+i.cantidad || 0)); });
    return Array.from(map.entries()).map(([x, y]) => ({ x, y }));
}

// Inicialización
async function init() {
    try {
        const r = await fetch(API_URL);
        if (!r.ok) throw new Error("Error de Red");
        const j = await r.json();
        
        DATA = j.evolucion_data || [];
        INDICES = j.indices_anuales || {};
        AGENTES = j.agentes_activos || [];
        
        // Ordenar y limpiar agentes
        AGENTES = AGENTES.filter(a => a !== "TODOS").sort();
        AGENTES.unshift("TODOS");
        
        AGENTE_SELECT.innerHTML = AGENTES.map(a => `<option value="${a}">${a}</option>`).join("");
        
        // Ocultar Loader
        LOADER.style.opacity = "0";
        setTimeout(() => LOADER.remove(), 500);

        updateUI();
    } catch (e) {
        console.error(e);
        document.querySelector(".loader-text").innerText = "ERROR DE CONEXIÓN. RECARGUE.";
        document.querySelector(".loader-text").style.color = "#ff5f56";
    }
}

function updateUI() {
    renderKPIs();
    renderChart();
    CHART_TITLE.innerText = `${accionActual}`;
}

// Lógica de Datos
function getSeries() {
    if (periodoActual === "MENSUAL") {
        // CORRECCIÓN PARA 2026: Calcular últimos 13 meses
        const months = [];
        const hoy = new Date();
        
        // Iteramos 12 meses hacia atrás desde hoy
        for (let i = 12; i >= 0; i--) {
            const d = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
            const y = d.getFullYear();
            const m = pad2(d.getMonth() + 1);
            months.push(`${y}-${m}`);
        }

        const recs = DATA.filter(i => (agenteActual==="TODOS"||i.agente===agenteActual) && i.accion===accionActual && i.fecha_mensual);
        const agg = aggregateSum(recs, i => i.fecha_mensual);
        
        return months.map(m => ({ x: `${m}-01`, y: agg.find(a => a.x === m)?.y || 0 }));
    } else {
        const daysBack = parseInt(periodoActual);
        const days = [];
        for (let i = daysBack - 1; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); days.push(formatDateISO(d)); }
        const recs = DATA.filter(i => (agenteActual==="TODOS"||i.agente===agenteActual) && i.accion===accionActual && i.fecha_diaria && days.includes(i.fecha_diaria));
        const agg = aggregateSum(recs, i => i.fecha_diaria);
        return days.map(d => ({ x: d, y: agg.find(x => x.x === d)?.y || 0 }));
    }
}

function renderChart() {
    const rawData = getSeries();
    const x = rawData.map(s => s.x);
    const y = rawData.map(s => s.y);
    
    // Texto personalizado para eje X con AÑO
    const tickText = rawData.map(s => {
        if(!s.x) return "";
        const p = s.x.split('-');
        if (periodoActual === "MENSUAL") {
            const nombreMes = MESES[parseInt(p[1])-1];
            const anioCorto = p[0].substring(2); 
            return `${nombreMes} '${anioCorto}`; // Ejemplo: ENE '26
        } else {
            return p[2];
        }
    });

    const hoverTemplate = '<span style="font-family:Rajdhani; font-size:14px; color: #8892b0">FECHA: %{text}</span><br>' +
                          '<span style="font-family:Orbitron; font-size:20px; font-weight:bold; color: #FFD700">CANT: %{y}</span><extra></extra>';

    // --- GRÁFICO BARRAS + LÍNEAS ---
    const data = [
        {
            x: x, y: y, text: tickText,
            type: "bar",
            hovertemplate: hoverTemplate,
            marker: { 
                color: "rgba(255, 215, 0, 0.6)", 
                line: { color: "#FFD700", width: 1 } 
            }
        },
        {
            x: x, y: y, text: tickText,
            type: "scatter", mode: "lines+markers",
            hovertemplate: hoverTemplate,
            line: { color: "#e6f1ff", width: 2 }, 
            marker: { 
                color: "#0A192F", 
                size: 8, 
                line: { color: "#FFD700", width: 2 } 
            }
        }
    ];

    const layout = {
        font: { family: 'Rajdhani', color: '#8892b0' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        height: 450,
        hoverlabel: {
            bgcolor: "#050b14", 
            bordercolor: "#FFD700", 
            font: { family: "Rajdhani", color: "#e6f1ff" } 
        },
        xaxis: { 
            gridcolor: 'rgba(255,255,255,0.05)', 
            tickmode: 'array', tickvals: x, ticktext: tickText,
            fixedrange: true 
        },
        yaxis: { 
            gridcolor: 'rgba(255,255,255,0.05)', 
            zerolinecolor: 'rgba(255,215,0,0.2)',
            fixedrange: true,
            rangemode: 'tozero'
        },
        margin: { t: 20, b: 40, l: 40, r: 20 },
        showlegend: false,
        dragmode: false
    };

    const config = { responsive: true, displayModeBar: false };
    Plotly.newPlot(PLOTLY_GRAPH_ID, data, layout, config);
}

function renderKPIs() {
    let vals = [0,0,0], isAvg = false;
    
    if (agenteActual !== "TODOS") {
        const k = INDICES[agenteActual] || {};
        vals = [k.Efectividad_Visitas||0, k.Efectividad_Reservas||0, k.Efectividad_Valuaciones||0];
    } else {
        const keys = Object.keys(INDICES);
        if (keys.length) {
            let sV=0,sR=0,sVa=0;
            keys.forEach(a => { sV+=INDICES[a]?.Efectividad_Visitas||0; sR+=INDICES[a]?.Efectividad_Reservas||0; sVa+=INDICES[a]?.Efectividad_Valuaciones||0; });
            vals = [sV/keys.length, sR/keys.length, sVa/keys.length];
            isAvg = true;
        }
    }

    const labels = [
        { title: "CONVERSIÓN VISITAS", icon: "fa-door-open" },
        { title: "CONVERSIÓN RESERVAS", icon: "fa-handshake" },
        { title: "CONVERSIÓN VALUACIONES", icon: "fa-tag" }
    ];

    KPI_CONTAINER.innerHTML = vals.map((v, i) => {
        let color = v < 0.05 ? "var(--accent-red)" : (v > 0.15 ? "var(--accent-green)" : "var(--accent-gold)");
        return `
        <div class="col-12 col-md-4">
            <div class="glass-card kpi-wrapper" style="border-bottom: 3px solid ${color}">
                <i class="fas ${labels[i].icon} kpi-icon"></i>
                <div class="kpi-title">${labels[i].title}</div>
                <div class="kpi-value" style="color: ${color}">
                    ${(v*100).toFixed(1)}%
                </div>
                ${isAvg ? '<span style="font-size:0.7em; opacity:0.5; margin-top:5px">PROMEDIO AGENCIA</span>' : ''}
            </div>
        </div>`;
    }).join("");
}

// Event Listeners
document.addEventListener("DOMContentLoaded", init);
AGENTE_SELECT.addEventListener("change", (e) => { agenteActual = e.target.value; updateUI(); });
ACCION_SELECT.addEventListener("change", (e) => { accionActual = e.target.value; updateUI(); });
TIME_BUTTONS.forEach(btn => btn.addEventListener('click', (e) => {
    TIME_BUTTONS.forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    periodoActual = e.target.dataset.period;
    renderChart();
}));
// --- OPTIMIZACIÓN DE RENDIMIENTO (DEBOUNCE) ---
// Evita que el gráfico sature la CPU al cambiar el tamaño de la ventana
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => { clearTimeout(timeout); func(...args); };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Ahora el gráfico solo se ajustará 200ms DESPUÉS de que el usuario deje de mover la ventana
window.addEventListener('resize', debounce(() => {
    Plotly.relayout(PLOTLY_GRAPH_ID, { autosize: true });
}, 200));

</script>
</body>
</html>