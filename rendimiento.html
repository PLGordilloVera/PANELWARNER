<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Rendimiento Agentes WARNER</title>
<base target="_top" />
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
/* 1. ESTILOS GENERALES Y DE FONDO (FORZADOS) */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #0A192F !important; /* FONDO OSCURO FORZADO */
    color: #ccd6f6 !important; /* COLOR DE TEXTO CLARO FORZADO */
    padding: 0;
    margin: 0;
}

.main-content-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    /* Reducimos el padding vertical general para compactar todo */
    padding: 10px 20px; 
    background-color: #0A192F; 
}

/* T√≠tulo estilo militar/tecnol√≥gico */
.military-title {
    text-align: center;
    /* Reducimos el margen inferior del t√≠tulo */
    margin-bottom: 20px; 
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 219, 16, 0.904);
}
.military-title h1 {
    font-family: 'Share Tech Mono', monospace;
    color: #FFD700; 
    font-size: clamp(1.8rem, 5vw, 2.8rem);
    font-weight: bold; 
    letter-spacing: 5px;
    text-shadow: 0 0 8px rgba(255,215,0,0.6), 0 0 12px rgba(255,215,0,0.4);
    margin: 0;
    padding: 0;
}

/* Estilo de tarjetas de control y gr√°fico */
.card {
    border: 2px solid rgba(255,255,255,0.7); 
    border-radius: 12px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    background-color: rgba(255,255,255,0.05);
    /* Margen inferior general eliminado o reducido */
    margin-bottom: 0px; 
    overflow: hidden;
}

.control-card {
    /* Ajuste de padding interior para no exagerar la altura */
    padding: 15px;
}

.control-card .form-label {
    color: #ffffff;
    font-weight: 700;
    text-align: center;
    display: block;
}

/* ************************************************************ */
/* FIX ALTURA TARJETAS DE CONTROL: Espacio inferior fijo para igualar */
.card-footer-spacer {
    font-size: 0.75rem;
    line-height: 1.2;
    margin-top: 8px; 
    margin-bottom: 0;
    padding-bottom: 0;
    text-align: center;
    min-height: 1.2em; 
    transition: color 0.3s;
}
/* ************************************************************ */


/* SOLUCI√ìN DE ALINEACI√ìN Y ALTURA DE KPIS */
#kpi-container {
    display: flex !important; 
    flex-direction: row;
    flex-wrap: wrap; 
    align-items: stretch !important;
    /* Espacio entre KPIs y el gr√°fico */
    margin-top: 15px; 
    margin-bottom: 15px !important;
}

/* Cada columna de KPI debe tener un margen inferior m√≠nimo */
#kpi-container > .col-md-4 { 
    display: flex !important; 
    flex-direction: column;
    height: 100%;
    margin-bottom: 15px; /* Peque√±o margen entre KPIs en m√≥vil */
}

/* Estilos de KPI (La Tarjeta Interna) */
.kpi-card {
    text-align: center;
    background-color: #112240; 
    border: 2px solid #ffffff; 
    border-radius: 10px;
    padding: 12px; /* Reducci√≥n de padding interior del KPI */
    flex-grow: 1; 
    min-height: 100px; /* Reducci√≥n de la altura m√≠nima */
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
    align-items: center; 
    transition: transform 0.3s, box-shadow 0.3s;
}

/* Resto de estilos est√©ticos */
.kpi-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4);
}
.kpi-disabled {
    opacity: 0.7; 
    cursor: default;
    transition: none; 
}
.kpi-disabled:hover {
    transform: none;
    box-shadow: none;
}
.kpi-title {
    font-size: 0.85rem; /* Reducci√≥n de tama√±o de texto de t√≠tulo */
    color: #8892b0; 
    margin-bottom: 5px;
    font-weight: 600;
    text-transform: uppercase;
}
.kpi-value {
    font-size: 1.7rem; /* Ligera reducci√≥n de tama√±o de valor */
    font-family: 'Share Tech Mono', monospace;
    color: #ffffff;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(199, 199, 199, 0.7);
}

/* Estilos de selectores */
.form-select-lg {
    border-radius: 8px;
    background-color: #112240;
    color: #ccd6f6;
    border: 2px solid #334455;
    padding: 8px 15px; /* Reducci√≥n de padding del selector */
    font-size: 0.95rem; /* Reducci√≥n de tama√±o de fuente del selector */
    width: 100%;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    /* SVG para la flecha de dropdown */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%2364FFDA' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px 12px;
}
.form-select-lg:focus {
    border-color: #ffffff;
    box-shadow: 0 0 0 0.25rem rgba(255,255,255,0.2);
    background-color: #1a2c4e;
    color: #ccd6f6;
}

/* Estilos de alertas */
.alert {
    border-radius: 8px;
}
.alert-danger {
    background-color: rgba(255,0,0,0.1);
    color: #FF6347;
    border: 1px solid #8B0000;
}
.alert-warning {
    background-color: rgba(255,255,0,0.1);
    color: #FFD700;
    border: 1px solid #DAA520;
}

/* Contenedor del gr√°fico */
#plotly-graph {
    width: 100%;
    height: 65vh;
    min-height: 500px; /* Reducci√≥n de la altura m√≠nima del gr√°fico */
    background-color: rgba(10,25,47,0.3);
    border-radius: 10px;
}

/* Asegurar que el contenido de la tarjeta del gr√°fico ocupe todo el espacio */
.chart-card-content {
    width: 100%;
    padding: 15px; /* Reducci√≥n de padding interior del gr√°fico */
    box-sizing: border-box;
}

/* Footer y l√≠nea de estado */
.footer-text {
    color: #8892b0;
    font-size: 0.8rem;
    margin-top: 15px; /* Reducci√≥n del margen superior del footer */
    text-align: center;
}

#status-line {
    text-align:center;
    color:#8892b0;
    margin-bottom:8px; /* Reducci√≥n del margen inferior de la l√≠nea de estado */
    font-size:0.9rem;
}
</style>
</head>
<body>

<div class="main-content-wrapper">
    <div class="military-title">
        <h1>RENDIMIENTO AGENTES WARNER</h1>
    </div>

    <div id="status-line">Conectando con API...</div>

    <!-- Eliminamos el margen inferior (mb-3 -> mb-0) -->
    <div class="row mb-0 justify-content-center align-items-start">
        <div class="col-md-5 col-lg-4 mb-3 mb-md-0">
            <div class="card control-card">
                <label for="agente-select" class="form-label mb-2">AGENTE</label>
                <select id="agente-select" class="form-select form-select-lg"></select>
                <!-- ELEMENTO ESPACIADOR 1 -->
                <p id="agente-id" class="card-footer-spacer" style="color: transparent;">&nbsp;</p>
            </div>
        </div>
        <div class="col-md-5 col-lg-4">
            <div class="card control-card">
                <label for="accion-select" class="form-label mb-2">M√âTRICA</label>
                <select id="accion-select" class="form-select form-select-lg"></select>
                <!-- ELEMENTO ESPACIADOR 2 -->
                <p class="card-footer-spacer" style="color: transparent;">&nbsp;</p>
            </div>
        </div>
    </div>

    <!-- Usamos un margen superior e inferior fijo para el espaciado (margin-y) -->
    <div class="row" id="kpi-container">
        <div class="col-md-4 col-sm-12">
            <div id="kpi-visitas" class="kpi-card">
                <div class="kpi-title">CONVERSION VISITAS</div>
                <div class="kpi-value">--</div>
            </div>
        </div>
        <div class="col-md-4 col-sm-12">
            <div id="kpi-reservas" class="kpi-card">
                <div class="kpi-title">CONVERSION RESERVAS</div>
                <div class="kpi-value">--</div>
            </div>
        </div>
        <div class="col-md-4 col-sm-12">
            <div id="kpi-tasaciones" class="kpi-card">
                <div class="kpi-title">CONVERSION VALUACIONES</div>
                <div class="kpi-value">--</div>
            </div>
        </div>
    </div>
    <!-- FIN CONTENEDOR DE KPIS -->

    <!-- La tarjeta principal ahora se pega directamente al contenedor de KPIs -->
    <div class="card mb-0"> 
        <div class="card-body p-0">
            <div class="chart-card-content">
                <div id="plotly-graph"> 
                    <div class="spinner-border text-white" role="status"><span class="visually-hidden">Cargando...</span></div>
                </div>
                <div id="plotly-graph-info" style="display:none; text-align:center; color:#e7e9f0; font-size:0.9rem; margin-top:10px;"></div>
                <div id="chart-description" class="text-center text-muted mt-3" style="font-size: 0.85rem; color: #8892b0;"></div>
            </div>
        </div>
    </div>

    <p class="footer-text">
        <small>Datos actualizados en tiempo real | Fuente: Google Sheets. Desarrollado por el equipo de An√°lisis.</small>
    </p>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script>
// ******************************************************************************
// * üö® ¬°ADVERTENCIA CR√çTICA! üö®
// * ESTA URL ES UN EJEMPLO. DEBES REEMPLAZARLA CON LA URL DE TU PROPIO SCRIPT 
// * DE GOOGLE APPS DESPLEGADO COMO APLICACI√ìN WEB (DEPLOY > NEW DEPLOYMENT).
// * LA URL DEBE TERMINAR EN "/exec".
// ******************************************************************************
const API_URL = 'https://script.google.com/macros/s/AKfycbxxJrJSkH6BCbJUmiCa2bYu1NbG7ip1Gqn0baqz94eom1QlhuqgESkbSUBVeb4uhTNA/exec'; // ¬°¬°¬°REEMPLAZAR ESTA URL!!!

let allEvolutionData = [];
let AGENTES_ACTIVOS_LIST = [];
let annualIndices = {};

const NOT_APPLICABLE_MESSAGE = '‚Äî'; 

function setStatus(text, isError = false) {
    $('#status-line').text(text).css('color', isError ? '#FF6347' : '#8892b0');
}

function formatKPIValue(value) {
    if (value === null || value === undefined || typeof value === 'boolean') return NOT_APPLICABLE_MESSAGE;
    if (typeof value !== 'number' || isNaN(value)) return NOT_APPLICABLE_MESSAGE;
    
    // Condici√≥n para forzar 100% si el valor es 1 (o menor)
    if (value <= 1) {
        // Si el valor es exactamente 1, devolver '100.0%'
        if (Math.abs(value - 1) < 0.001) return '100.0%';
        
        // Para valores menores a 1, usar el formato de porcentaje normal
        return (value * 100).toFixed(1) + '%';
    }
    
    // Si es mayor a 1, devolver el valor redondeado como n√∫mero entero
    return Math.round(value).toLocaleString('es-AR');
}

function renderKpis(agente) {
    // El elemento #agente-id se mantiene como un espaciador invisible fijo para igualar la altura.
    $('#agente-id').text('\u00a0').css('color', 'transparent'); 

    // Nota: Los KPIs solo tienen sentido para agentes individuales.
    const isAllAgents = agente === 'TODOS';
    const indices = annualIndices && annualIndices[agente] && !isAllAgents ? annualIndices[agente] : {};
    
    const visitas = isAllAgents ? NOT_APPLICABLE_MESSAGE : formatKPIValue(indices.Efectividad_Visitas);
    const reservas = isAllAgents ? NOT_APPLICABLE_MESSAGE : formatKPIValue(indices.Efectividad_Reservas);
    const tasaciones = isAllAgents ? NOT_APPLICABLE_MESSAGE : formatKPIValue(indices.Efectividad_Valuaciones);

    $('#kpi-visitas .kpi-value').text(visitas);
    $('#kpi-reservas .kpi-value').text(reservas);
    $('#kpi-tasaciones .kpi-value').text(tasaciones);
    
    // Deshabilita el hover en KPIs cuando es "TODOS" para indicar que no son aplicables
    if (isAllAgents) {
        $('.kpi-card').addClass('kpi-disabled');
    } else {
        $('.kpi-card').removeClass('kpi-disabled');
    }
}

function mapMetricName(internalName) {
    switch(internalName) {
        case 'CAPTAC. (EXCLUSIVIDAD + AUTORIZACI√ìN)': return 'CAPTACIONES (VENTA)';
        case 'CLIENTES NUEVOS': return 'CLIENTES';
        case 'OPERACIONES': return 'OPERACIONES';
        case 'RESERVAS': return 'RESERVAS';
        case 'RESE√ëAS': return 'RESE√ëAS';
        case 'TASACIONES': return 'TASACIONES';
        case 'VISITAS': return 'VISITAS';
        default: return internalName || 'SIN M√âTRICA';
    }
}

function drawGraph(agente, accion) {
    const graphDiv = $('#plotly-graph')[0];
    if (!agente || !accion) {
        // Si no hay selecci√≥n, mostramos un mensaje de gu√≠a.
        $('#plotly-graph').css({ display: 'flex', 'align-items': 'center', 'justify-content': 'center' }) 
                         .html('<div class="alert alert-warning text-center p-4">Selecciona un agente y una m√©trica para visualizar los datos.</div>');
        renderKpis(agente);
        return;
    }

    // Si hay datos, restauramos la configuraci√≥n normal para Plotly.
    $('#plotly-graph').css({ display: '', 'align-items': '', 'justify-content': '' });

    // Filtramos los datos
    let filtered = [];
    if (agente === 'TODOS') {
        // Si es 'TODOS', solo filtramos por la acci√≥n
        filtered = allEvolutionData.filter(d => (d.accion === accion));
    } else {
        // Si es un agente individual, filtramos por agente y acci√≥n
        filtered = allEvolutionData.filter(d => (d.agente === agente) && (d.accion === accion));
    }

    renderKpis(agente);

    let baseYear = new Date().getFullYear();
    if (allEvolutionData.length > 0) {
        const firstDate = allEvolutionData.map(d => new Date(d.fecha)).filter(dt => !isNaN(dt))[0];
        if (firstDate && !isNaN(firstDate.getTime())) baseYear = firstDate.getFullYear();
    }

    const xData = [];
    const yData = [];
    // Generar 9 meses: Ene(0) a Sep(8) del baseYear
    for (let m = 0; m < 9; m++) {
        const monthStart = new Date(baseYear, m, 1);
        const monthKey = monthStart.toISOString().split('T')[0];
        xData.push(monthKey);

        const monthPrefix = monthKey.slice(0,7);
        const sum = filtered
            .filter(r => typeof r.fecha === 'string' && r.fecha.slice(0,7) === monthPrefix)
            .reduce((acc, cur) => acc + (Number(cur.cantidad) || 0), 0);
        yData.push(sum);
    }

    const totalSum = yData.reduce((a,b) => a + b, 0);
    const metricTitle = mapMetricName(accion);

    const barTrace = {
        x: xData,
        y: yData,
        type: 'bar',
        name: 'Frecuencia',
        marker: { color: yData.map(() => '#ffffff'), line: { color: 'rgba(224,224,224,0.5)', width: 1 } },
        customdata: yData.map(v => totalSum > 0 ? (v / totalSum) * 100 : 0),
        hovertemplate: '%{x|%b %Y}<br>Cantidad: %{y}<br>Porcentaje: %{customdata:.1f}%<extra></extra>',
        hoverinfo: 'x+y+customdata'
    };

    const trendTrace = {
        x: xData,
        y: yData,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Tendencia',
        line: { color: '#FFD700', width: 4, shape: 'spline', smoothing: 1 },
        marker: { size: 8, color: '#FFD700', line: { width: 1, color: 'rgba(255,255,255,0.7)' } },
        hoverinfo: 'x+y',
        hoveron: 'points+lines'
    };

    const layout = {
        autosize: true,
        title: { 
            text: `EVOLUCI√ìN MENSUAL: ${metricTitle} (${agente})`, 
            font: { 
                size: 22, 
                color: '#FFD700', 
                family: 'Share Tech Mono, monospace' 
            }, 
            y: 0.95 
        },
        xaxis: {
            type: 'date',
            tickformat: '%b %Y',
            tickangle: -45,
            gridcolor: 'rgba(255,255,255,0.1)',
            linecolor: 'rgba(255,255,255,0.2)',
            // Color de las etiquetas del eje X (meses)
            tickfont: { color: '#ffffff', size: 12 }, 
            title: {
                font: { color: '#ffffff' } 
            },
            automargin: true
        },
        yaxis: {
            rangemode: 'tozero',
            gridcolor: 'rgba(255,255,255,0.08)',
            zerolinecolor: 'rgba(255,255,255,0.15)',
            // Color de las etiquetas del eje Y (valores)
            tickfont: { color: '#ffffff', size: 12 }, 
            title: {
                font: { color: '#ffffff' } 
            },
            automargin: true
        },
        margin: { t: 100, b: 140, l: 40, r: 20 },
        plot_bgcolor: 'rgba(10,25,47,0.3)',
        paper_bgcolor: 'rgba(10,25,47,0.5)',
        hovermode: 'x unified',
        showlegend: true,
        // Color del texto de la leyenda
        legend: {
            font: { color: '#ffffff' } 
        }
    };

    graphDiv.innerHTML = '';
    // Aseguramos que Plotly sea responsivo, la clave para el redimensionamiento.
    Plotly.newPlot(graphDiv, [barTrace, trendTrace], layout, { responsive: true, displayModeBar: false })
        .catch(err => {
            console.error('Plotly newPlot error:', err);
            // Ajuste: Aseguramos que el error de dibujo se vea centrado.
            $('#plotly-graph').css({ display: 'flex', 'align-items': 'center', 'justify-content': 'center' })
                             .html('<div class="alert alert-danger text-center p-4">Error al dibujar el gr√°fico.</div>');
        });
}

async function loadData() {
    // El spinner debe estar centrado.
    $('#plotly-graph').css({ display: 'flex', 'align-items': 'center', 'justify-content': 'center' })
                     .html('<div class="spinner-border text-white" role="status"><span class="visually-hidden">Cargando...</span></div>');
    setStatus('Conectando con API...');

    try {
        const maxRetries = 3;
        let attempt = 0;
        let apiResponse = null;

        while (attempt < maxRetries) {
            attempt++;
            try {
                // Exponential backoff logic
                const resp = await fetch(API_URL, { method: 'GET', cache: 'no-store' });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                apiResponse = await resp.json();
                break;
            } catch (err) {
                console.warn(`Intento ${attempt} fallido: ${err.message}`);
                if (attempt >= maxRetries) throw err;
                await new Promise(res => setTimeout(res, Math.pow(2, attempt) * 500));
            }
        }

        if (!apiResponse || !Array.isArray(apiResponse.evolucion_data) || !Array.isArray(apiResponse.agentes_activos)) {
            let errorDetail = 'La respuesta de la API no contiene las propiedades esperadas (`evolucion_data`, `agentes_activos`, `indices_anuales`) o est√°n vac√≠as.';
            if (apiResponse && !Array.isArray(apiResponse.evolucion_data)) {
                 errorDetail = 'El campo `evolucion_data` no es un array.';
            } else if (apiResponse && !Array.isArray(apiResponse.agentes_activos)) {
                 errorDetail = 'El campo `agentes_activos` no es un array.';
            }

            throw new Error(errorDetail);
        }

        allEvolutionData = apiResponse.evolucion_data;
        AGENTES_ACTIVOS_LIST = apiResponse.agentes_activos;
        annualIndices = apiResponse.indices_anuales || {};

        if (!AGENTES_ACTIVOS_LIST.length) {
            setStatus('‚ùå No se encontraron agentes activos en la respuesta.', true);
            $('#plotly-graph').css({ display: 'flex', 'align-items': 'center', 'justify-content': 'center' })
                             .html('<div class="alert alert-danger text-center p-4">‚ùå Error: No hay agentes activos.</div>');
            renderKpis(null);
            return;
        }

        // **********************************************
        // * MODIFICACI√ìN CLAVE: Agregar y ordenar 'TODOS'
        // **********************************************
        let agentes = AGENTES_ACTIVOS_LIST.slice();
        // 1. Agregar 'TODOS' si no existe
        if (!agentes.includes('TODOS')) {
            agentes.push('TODOS');
        }

        // 2. Ordenar: 'TODOS' primero, luego el resto alfab√©ticamente
        agentes.sort((a, b) => {
            if (a === 'TODOS') return -1;
            if (b === 'TODOS') return 1;
            return a.localeCompare(b);
        });
        // **********************************************
        
        const acciones_raw = Array.from(new Set(allEvolutionData.map(d => d.accion))).sort();
        const acciones = acciones_raw.map(a => ({ value: a, label: mapMetricName(a) }));

        const $agenteSelect = $('#agente-select');
        const $accionSelect = $('#accion-select');

        $agenteSelect.empty().append('<option value="" disabled selected>-- Seleccionar Agente --</option>');
        agentes.forEach(a => $agenteSelect.append(`<option value="${a}">${a}</option>`));

        if (acciones.length) {
            $accionSelect.empty().append('<option value="" disabled selected>-- Seleccionar M√©trica --</option>');
            acciones.forEach(a => $accionSelect.append(`<option value="${a.value}">${a.label}</option>`));
        } else {
            $accionSelect.empty().append('<option value="" disabled selected>No hay m√©tricas</option>');
        }

        $agenteSelect.off('change').on('change', () => drawGraph($agenteSelect.val(), $accionSelect.val()));
        $accionSelect.off('change').on('change', () => drawGraph($agenteSelect.val(), $accionSelect.val()));

        // **********************************************
        // * MODIFICACI√ìN CLAVE: Seleccionar 'TODOS' por defecto
        // **********************************************
        let defaultAgente = agentes.includes('TODOS') ? 'TODOS' : (agentes.includes('PEDRO APUD') ? 'PEDRO APUD' : agentes[1] || agentes[0]); 
        const defaultAccion = acciones.length > 0 ? acciones[0].value : null;

        if (defaultAgente) $agenteSelect.val(defaultAgente);
        if (defaultAccion) $accionSelect.val(defaultAccion);

        setStatus('‚úÖ Datos cargados correctamente.');
        if (defaultAgente && defaultAccion) drawGraph(defaultAgente, defaultAccion);
        else {
            // Mensaje inicial de gu√≠a.
            $('#plotly-graph').css({ display: 'flex', 'align-items': 'center', 'justify-content': 'center' })
                             .html('<div class="alert alert-warning text-center p-4">Selecciona un agente y una m√©trica para visualizar los datos.</div>');
            renderKpis(defaultAgente);
        }

    } catch (error) {
        console.error('Error al cargar datos desde API:', error);
        // Mensaje de error detallado al usuario
        setStatus('‚ùå Error al obtener datos desde la API. ' + (error.message || 'Verifique la URL y el despliegue del Apps Script.'), true);
        $('#plotly-graph').css({ display: 'flex', 'align-items': 'center', 'justify-content': 'center' })
                         .html(`<div class="alert alert-danger text-center p-4">
                                ‚ùå Error de Conexi√≥n/Datos: No se pudo obtener la informaci√≥n.
                                <br>
                                <small>Detalle: ${error.message || 'Error desconocido'}. Aseg√∫rese de que la <strong>API_URL</strong> sea la URL p√∫blica de su Apps Script.</small>
                            </div>`);
        renderKpis(null);
    }
}

$(document).ready(loadData);
</script>
</body>
</html>