<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Rendimiento Agentes WARNER</title>
<base target="_top" />

<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@600;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
/* ---------------------------------------------------- */
/* === VARIABLES & CORE === */
/* ---------------------------------------------------- */
:root {
    --bg-deep: #050b14;
    --bg-card: rgba(16, 33, 60, 0.65);
    --text-main: #e6f1ff;
    --text-muted: #8892b0;
    --accent-gold: #ffe863;
    --accent-gold-dark: #f1cb1f;
    --accent-gold-glow: rgba(255, 215, 0, 0.3);
    --accent-green: #64ffda;
    --accent-red: #ff5f56;
    --accent-blue: #3498db;
    --border-glass: rgba(255, 255, 255, 0.1);
    --font-tech: 'Rajdhani', sans-serif;
    --font-display: 'Orbitron', sans-serif;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-deep);
    color: var(--text-main);
    background-image: 
        radial-gradient(at 0% 0%, rgba(255, 215, 0, 0.08) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(10, 25, 47, 1) 0px, transparent 50%);
    background-attachment: fixed;
    min-height: 100vh;
    overflow-x: hidden;
}

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-deep); }
::-webkit-scrollbar-thumb { background: #30415a; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-gold); }

.main-content-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
    padding-bottom: 120px;
    animation: fadeIn 1s ease-out;
    position: relative;
    z-index: 1;
}

/* ---------------------------------------------------- */
/* === COMPONENTS DASHBOARD === */
/* ---------------------------------------------------- */

.cyber-header {
    text-align: center;
    margin-bottom: 50px;
    position: relative;
}

.cyber-header h1 {
    font-family: var(--font-display);
    font-size: clamp(1.8rem, 4vw, 3rem);
    background: linear-gradient(180deg, var(--accent-gold) 0%, var(--accent-gold-dark) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    text-transform: uppercase;
    letter-spacing: 4px;
    margin-bottom: 10px;
    filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
}

.status-pill {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    background: rgba(100, 255, 218, 0.1);
    border: 1px solid var(--accent-green);
    color: var(--accent-green);
    font-family: var(--font-tech);
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 1px;
}

.glass-card {
    background: var(--bg-card);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--border-glass);
    border-radius: 12px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    height: 100%;
}

.glass-card:hover {
    border-color: rgba(255, 215, 0, 0.3);
    box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.5);
}

.control-card { padding: 25px; }

.form-label {
    font-family: var(--font-tech);
    color: var(--accent-gold);
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-size: 0.9rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-select {
    background-color: rgba(5, 11, 20, 0.6) !important;
    color: #fff !important;
    border: 1px solid #30415a !important;
    border-radius: 6px;
    font-family: 'Inter', sans-serif;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.form-select:hover, .form-select:focus {
    border-color: var(--accent-gold) !important;
    box-shadow: 0 0 15px var(--accent-gold-glow) !important;
}

/* KPI CARDS */
.kpi-wrapper {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 30px 20px;
    position: relative;
    overflow: hidden;
}
.kpi-wrapper::after {
    content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
    background: var(--accent-gold); opacity: 0.5; transition: 0.3s;
}
.kpi-wrapper:hover::after { opacity: 1; box-shadow: 0 0 10px var(--accent-gold); }
.kpi-icon { font-size: 1.5rem; color: var(--text-muted); margin-bottom: 10px; }
.kpi-title { font-family: var(--font-tech); color: var(--text-muted); font-size: 1rem; letter-spacing: 2px; text-transform: uppercase; }
.kpi-value { font-family: var(--font-display); font-size: 2.8rem; font-weight: 700; color: #fff; margin-top: 5px; text-shadow: 0 0 20px rgba(255,255,255,0.1); }

/* CHART CONTAINER */
.chart-container { padding: 20px; min-height: 500px; position: relative; }
.chart-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px; padding: 0 10px; border-bottom: 1px solid var(--border-glass); padding-bottom: 15px; }
.chart-title { font-family: var(--font-tech); font-size: 1.5rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
.toolbar { display: flex; gap: 8px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 8px; }
.time-btn { background: transparent; border: none; color: var(--text-muted); font-family: var(--font-tech); font-weight: 700; padding: 6px 16px; border-radius: 6px; transition: all 0.3s; font-size: 0.9rem; }
.time-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
.time-btn.active { background: var(--accent-gold); color: #000; box-shadow: 0 0 15px var(--accent-gold-glow); }

/* LOADER */
#loader-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-deep); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    flex-direction: column; transition: opacity 0.5s;
}
.loader-spinner { width: 60px; height: 60px; border: 3px solid transparent; border-top-color: var(--accent-gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
.loader-text { font-family: var(--font-display); letter-spacing: 3px; animation: pulse 1.5s infinite; color: var(--accent-gold); }

/* FOOTER */
.footer-author { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 4rem; font-family: var(--font-tech); color: var(--text-muted); font-weight: 700; letter-spacing: 2px; padding-bottom: 20px; }
.github-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--accent-gold); transition: transform 0.3s, box-shadow 0.3s; vertical-align: middle; }
.github-avatar:hover { transform: scale(1.15); box-shadow: 0 0 15px var(--accent-gold); cursor: pointer; }

/* ---------------------------------------------------- */
/* === ESTILOS DEL CHATBOT IA === */
/* ---------------------------------------------------- */

#chat-btn {
    position: fixed; bottom: 30px; right: 30px;
    width: 60px; height: 60px;
    /* Estilo Elite: Degradado Naranja/Dorado */
    background: linear-gradient(135deg, var(--accent-gold), #e67e22);
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
    cursor: pointer; 
    z-index: 2147483647; /* Máximo z-index para asegurar visibilidad */
    transition: transform 0.3s;
    border: 2px solid #fff;
}
#chat-btn:hover { transform: scale(1.1) rotate(10deg); }
#chat-btn i { font-size: 24px; color: #000; }

#chat-window {
    position: fixed; bottom: 100px; right: 30px;
    /* --- CAMBIO: ANCHO AUMENTADO A 480PX --- */
    width: 480px; 
    height: 550px; /* También aumentamos un poco el alto */
    background: var(--bg-deep); 
    border: 1px solid var(--accent-gold);
    border-radius: 12px;
    display: flex; flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    z-index: 2147483647;
    transform: translateY(20px); opacity: 0; pointer-events: none;
    transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    overflow: hidden;
}
#chat-window.open { transform: translateY(0); opacity: 1; pointer-events: all; }

.chat-header {
    background: rgba(255, 215, 0, 0.1);
    padding: 15px; border-bottom: 1px solid var(--border-glass);
    display: flex; justify-content: space-between; align-items: center;
}
.chat-title { font-family: var(--font-display); font-size: 14px; color: var(--accent-gold); letter-spacing: 1px; }

.chat-messages {
    flex-grow: 1; padding: 15px; overflow-y: auto;
    font-size: 14px; /* Letra un poquito más grande para el ancho nuevo */
    display: flex; flex-direction: column; gap: 10px;
}

/* Burbujas de Mensaje */
.msg { padding: 12px 16px; border-radius: 8px; max-width: 85%; line-height: 1.5; word-wrap: break-word; }
.msg.user { 
    align-self: flex-end; 
    background: rgba(52, 152, 219, 0.2); 
    border: 1px solid var(--accent-blue); 
    color: #fff; 
}
.msg.ai { 
    align-self: flex-start; 
    background: rgba(255, 255, 255, 0.05); 
    border: 1px solid var(--border-glass); 
    color: #ccc; 
}
.msg.ai strong { color: var(--accent-gold); }
.msg.ai p { margin: 0; margin-bottom: 8px; }
.msg.ai p:last-child { margin-bottom: 0; }
.msg.ai ul { padding-left: 20px; margin: 0; }

.chat-input-area {
    padding: 15px; border-top: 1px solid var(--border-glass);
    display: flex; gap: 10px; 
    background: rgba(0,0,0,0.3);
}
#chatInput {
    flex-grow: 1; background: transparent; border: 1px solid var(--text-muted);
    border-radius: 4px; color: #fff; padding: 8px; font-family: 'Inter'; font-size: 13px;
}
#chatInput:focus { border-color: var(--accent-gold); outline: none; }
#sendBtn {
    background: var(--accent-gold); border: none; border-radius: 4px;
    width: 35px; cursor: pointer; color: #000; display: flex; justify-content: center; align-items: center;
}

.typing-indicator { font-size: 10px; color: var(--accent-gold); font-style: italic; margin-left: 10px; display: none; margin-bottom: 5px;}

@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

/* ========================================= */
/* === RESPONSIVE FIXES (MÓVIL) === */
/* ========================================= */
@media (max-width: 768px) {
    .kpi-value { font-size: 2.2rem; }
    .chart-header { flex-direction: column; align-items: flex-start; gap: 15px; }
    .toolbar { width: 100%; justify-content: space-between; }
    .time-btn { padding: 6px 10px; font-size: 0.8rem; }
    
    #chat-btn {
        position: fixed !important;
        bottom: 15vh !important;
        right: 20px !important;
        width: 55px !important;
        height: 55px !important;
        z-index: 2147483647 !important;
        display: flex !important;
        box-shadow: 0 0 15px #ffe863 !important;
    }
    #chat-btn i { font-size: 22px !important; }

    #chat-window {
        position: fixed !important;
        /* En móvil forzamos que sea el 90% para que no se salga de pantalla */
        width: 90% !important; 
        right: 5% !important;
        bottom: calc(15vh + 70px) !important;
        height: 50vh !important;
        z-index: 2147483647 !important;
        background: var(--bg-deep) !important; 
        backdrop-filter: none !important;
    }
}
</style>
</head>

<body>

<div id="loader-overlay">
    <div class="loader-spinner"></div>
    <div class="loader-text">SINCRONIZANDO WARNER...</div>
</div>

<div class="main-content-wrapper">

    <header class="cyber-header">
        <h1>WARNER RENDIMIENTO</h1>
        <div id="status-pill-container">
            <span class="status-pill"><i class="fas fa-circle fa-xs me-2"></i>SISTEMA ACTIVO</span>
        </div>
    </header>

    <div class="row g-4 mb-4">
        <div class="col-12 col-md-6">
            <div class="glass-card control-card">
                <label for="agente-select" class="form-label"><i class="fas fa-user-astronaut"></i> AGENTE</label>
                <select id="agente-select" class="form-select">
                    <option value="">Cargando directorio...</option>
                </select>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="glass-card control-card">
                <label for="accion-select" class="form-label"><i class="fas fa-chart-line"></i> METRICA</label>
                <select id="accion-select" class="form-select">
                    <option value="CAPTACIONES">CAPTACIONES</option>
                    <option value="CARTELES">CARTELES</option>
                    <option value="CLIENTES">CLIENTES COMPRADORES</option>
                    <option value="CLIENTES VENDEDORES">CLIENTES VENDEDORES</option>
                    <option value="OPERACIONES CAPTADOR">OPERACIONES (CAPTADOR)</option>
                    <option value="OPERACIONES COLOCADOR">OPERACIONES (COLOCADOR)</option>
                    <option value="RESERVAS">RESERVAS</option>
                    <option value="RESEÑAS">RESEÑAS</option>
                    <option value="VALUACIONES">VALUACIONES REALIZADAS</option>
                    <option value="VISITAS">VISITAS A INMUEBLES</option>
                </select>
            </div>
        </div>
    </div>

    <div id="kpi-container" class="row mb-4 g-4"></div>

    <div class="glass-card chart-container">
        <div class="chart-header">
            <div class="chart-title">
                <i class="fas fa-poll" style="color:var(--accent-gold)"></i>
                <span id="chart-title-text">RENDIMIENTO HISTÓRICO</span>
            </div>
            <div class="toolbar">
                <button class="time-btn" data-period="7">7 D</button>
                <button class="time-btn" data-period="15">15 D</button>
                <button class="time-btn" data-period="30">30 D</button>
                <button class="time-btn active" data-period="MENSUAL">HIST</button>
            </div>
        </div>
        <div id="plotly-graph"></div>
    </div>

    <footer class="footer-author">
        CREATED BY 
        <a href="https://github.com/PLGordilloVera" target="_blank" title="Ver perfil de GitHub">
            <img src="https://github.com/PLGordilloVera.png" alt="Autor" class="github-avatar" />
        </a>
    </footer>

</div> 
<div id="chat-btn" onclick="toggleChat()">
    <i class="fas fa-robot"></i>
</div>

<div id="chat-window">
    <div class="chat-header">
        <span class="chat-title"><i class="fas fa-brain me-2"></i>WARNER AI ANALYST</span>
        <i class="fas fa-times" style="cursor:pointer; color:#8892b0;" onclick="toggleChat()"></i>
    </div>
    <div id="chatMessages" class="chat-messages">
        <div class="msg ai">
            Hola. Soy la IA de Warner. Tengo acceso a las métricas de todos los agentes. <strong>¿Qué quieres analizar hoy?</strong>
        </div>
    </div>
    <div class="typing-indicator" id="typingIndicator">Analizando datos...</div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Ej: ¿Quién tuvo más reservas en Marzo?" onkeypress="checkEnter(event)">
        <button id="sendBtn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
// Referencias DOM Dashboard
const LOADER = document.getElementById("loader-overlay");
const AGENTE_SELECT = document.getElementById("agente-select");
const ACCION_SELECT = document.getElementById("accion-select");
const KPI_CONTAINER = document.getElementById("kpi-container");
const CHART_TITLE = document.getElementById("chart-title-text");
const PLOTLY_GRAPH_ID = "plotly-graph";
const TIME_BUTTONS = document.querySelectorAll('.time-btn');

let DATA = [], INDICES = {}, AGENTES = [];
let agenteActual = "TODOS", accionActual = "CAPTACIONES", periodoActual = "MENSUAL";
const MESES = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];

// Utilidades
const pad2 = (n) => String(n).padStart(2, '0');
const formatDateISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

function aggregateSum(items, keyExtractor) {
    const map = new Map();
    items.forEach(i => { const k = keyExtractor(i); map.set(k, (map.get(k) || 0) + (+i.cantidad || 0)); });
    return Array.from(map.entries()).map(([x, y]) => ({ x, y }));
}

// --- CARGA DE DATOS ---
window.onload = function() {
    google.script.run
        .withSuccessHandler(initDashboard)
        .withFailureHandler(onLoadError)
        .obtenerDatosDashboard(); 
};

function initDashboard(jsonString) {
    try {
        const j = JSON.parse(jsonString);
        
        DATA = j.evolucion_data || [];
        INDICES = j.indices_anuales || {};
        AGENTES = j.agentes_activos || [];
        
        AGENTES = AGENTES.filter(a => a !== "TODOS").sort();
        AGENTES.unshift("TODOS");
        
        AGENTE_SELECT.innerHTML = AGENTES.map(a => `<option value="${a}">${a}</option>`).join("");
        
        LOADER.style.opacity = "0";
        setTimeout(() => LOADER.remove(), 500);

        updateUI();
    } catch (e) {
        onLoadError(e);
    }
}

function onLoadError(e) {
    console.error(e);
    document.querySelector(".loader-text").innerText = "ERROR CRÍTICO: " + e.message;
    document.querySelector(".loader-text").style.color = "#ff5f56";
}

function updateUI() {
    renderKPIs();
    renderChart();
    CHART_TITLE.innerText = `${accionActual}`;
}

function getSeries() {
    if (periodoActual === "MENSUAL") {
        const months = [];
        const hoy = new Date();
        for (let i = 12; i >= 0; i--) {
            const d = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
            const y = d.getFullYear();
            const m = pad2(d.getMonth() + 1);
            months.push(`${y}-${m}`);
        }

        const recs = DATA.filter(i => (agenteActual==="TODOS"||i.agente===agenteActual) && i.accion===accionActual && i.fecha_mensual);
        const agg = aggregateSum(recs, i => i.fecha_mensual);
        
        return months.map(m => ({ x: `${m}-01`, y: agg.find(a => a.x === m)?.y || 0 }));
    } else {
        const daysBack = parseInt(periodoActual);
        const days = [];
        for (let i = daysBack - 1; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); days.push(formatDateISO(d)); }
        const recs = DATA.filter(i => (agenteActual==="TODOS"||i.agente===agenteActual) && i.accion===accionActual && i.fecha_diaria && days.includes(i.fecha_diaria));
        const agg = aggregateSum(recs, i => i.fecha_diaria);
        return days.map(d => ({ x: d, y: agg.find(x => x.x === d)?.y || 0 }));
    }
}

function renderChart() {
    const rawData = getSeries();
    const x = rawData.map(s => s.x);
    const y = rawData.map(s => s.y);
    
    const tickText = rawData.map(s => {
        if(!s.x) return "";
        const p = s.x.split('-');
        if (periodoActual === "MENSUAL") {
            const nombreMes = MESES[parseInt(p[1])-1];
            const anioCorto = p[0].substring(2); 
            return `${nombreMes} '${anioCorto}`;
        } else {
            return p[2];
        }
    });

    const hoverTemplate = '<span style="font-family:Rajdhani; font-size:14px; color: #8892b0">FECHA: %{text}</span><br>' +
                          '<span style="font-family:Orbitron; font-size:20px; font-weight:bold; color: #FFD700">CANT: %{y}</span><extra></extra>';

    const data = [
        {
            x: x, y: y, text: tickText,
            type: "bar",
            hovertemplate: hoverTemplate,
            marker: { color: "rgba(255, 215, 0, 0.6)", line: { color: "#FFD700", width: 1 } }
        },
        {
            x: x, y: y, text: tickText,
            type: "scatter", mode: "lines+markers",
            hovertemplate: hoverTemplate,
            line: { color: "#e6f1ff", width: 2 }, 
            marker: { color: "#0A192F", size: 8, line: { color: "#FFD700", width: 2 } }
        }
    ];

    const layout = {
        font: { family: 'Rajdhani', color: '#8892b0' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        height: 450,
        hoverlabel: { bgcolor: "#050b14", bordercolor: "#FFD700", font: { family: "Rajdhani", color: "#e6f1ff" } },
        xaxis: { gridcolor: 'rgba(255,255,255,0.05)', tickmode: 'array', tickvals: x, ticktext: tickText, fixedrange: true },
        yaxis: { gridcolor: 'rgba(255,255,255,0.05)', zerolinecolor: 'rgba(255,215,0,0.2)', fixedrange: true, rangemode: 'tozero' },
        margin: { t: 20, b: 40, l: 40, r: 20 },
        showlegend: false,
        dragmode: false
    };

    const config = { responsive: true, displayModeBar: false };
    Plotly.newPlot(PLOTLY_GRAPH_ID, data, layout, config);
}

function renderKPIs() {
    let vals = [0,0,0], isAvg = false;
    
    if (agenteActual !== "TODOS") {
        const k = INDICES[agenteActual] || {};
        vals = [k.Efectividad_Visitas||0, k.Efectividad_Reservas||0, k.Efectividad_Valuaciones||0];
    } else {
        const keys = Object.keys(INDICES);
        if (keys.length) {
            let sV=0,sR=0,sVa=0;
            keys.forEach(a => { sV+=INDICES[a]?.Efectividad_Visitas||0; sR+=INDICES[a]?.Efectividad_Reservas||0; sVa+=INDICES[a]?.Efectividad_Valuaciones||0; });
            vals = [sV/keys.length, sR/keys.length, sVa/keys.length];
            isAvg = true;
        }
    }

    const labels = [
        { title: "CONVERSIÓN VISITAS", icon: "fa-door-open" },
        { title: "CONVERSIÓN RESERVAS", icon: "fa-handshake" },
        { title: "CONVERSIÓN VALUACIONES", icon: "fa-tag" }
    ];

    KPI_CONTAINER.innerHTML = vals.map((v, i) => {
        let color = v < 0.05 ? "var(--accent-red)" : (v > 0.15 ? "var(--accent-green)" : "var(--accent-gold)");
        return `
        <div class="col-12 col-md-4">
            <div class="glass-card kpi-wrapper" style="border-bottom: 3px solid ${color}">
                <i class="fas ${labels[i].icon} kpi-icon"></i>
                <div class="kpi-title">${labels[i].title}</div>
                <div class="kpi-value" style="color: ${color}">
                    ${(v*100).toFixed(1)}%
                </div>
                ${isAvg ? '<span style="font-size:0.7em; opacity:0.5; margin-top:5px">PROMEDIO AGENCIA</span>' : ''}
            </div>
        </div>`;
    }).join("");
}

AGENTE_SELECT.addEventListener("change", (e) => { agenteActual = e.target.value; updateUI(); });
ACCION_SELECT.addEventListener("change", (e) => { accionActual = e.target.value; updateUI(); });
TIME_BUTTONS.forEach(btn => btn.addEventListener('click', (e) => {
    TIME_BUTTONS.forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    periodoActual = e.target.dataset.period;
    renderChart();
}));
window.addEventListener('resize', () => Plotly.relayout(PLOTLY_GRAPH_ID, { autosize: true }));

// --- LÓGICA DEL CHATBOT ---
function toggleChat() {
    document.getElementById('chat-window').classList.toggle('open');
}
function checkEnter(e) { if(e.key === 'Enter') sendMessage(); }

function sendMessage() {
    const input = document.getElementById('chatInput');
    const txt = input.value.trim();
    if(!txt) return;

    addMsg(txt, 'user');
    input.value = '';
    
    document.getElementById('typingIndicator').style.display = 'block';
    const msgsDiv = document.getElementById('chatMessages');
    msgsDiv.scrollTop = msgsDiv.scrollHeight;

    google.script.run
        .withSuccessHandler(onAiResponse)
        .withFailureHandler(onAiError)
        .consultarIA(txt, DATA); 
}

function onAiResponse(response) {
    document.getElementById('typingIndicator').style.display = 'none';
    const htmlText = marked.parse(response);
    addMsg(htmlText, 'ai');
}

function onAiError(e) {
    document.getElementById('typingIndicator').style.display = 'none';
    addMsg("Error: " + e.message, 'ai');
}

function addMsg(html, type) {
    const div = document.createElement('div');
    div.className = 'msg ' + type;
    div.innerHTML = html;
    document.getElementById('chatMessages').appendChild(div);
    const box = document.getElementById('chatMessages');
    box.scrollTop = box.scrollHeight;
}
</script>
</body>
</html>